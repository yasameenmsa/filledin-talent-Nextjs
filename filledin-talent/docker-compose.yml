version: '3.8'

networks:
  # 1. Create a secure, isolated network
  filledin_secure_net:
    internal: true # Blocks outbound internet for services on this network
    name: filledin_secure_net

services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
      # Args usually not needed for runtime envs, but keeping if your build needs them
      args:
        MONGODB_URI: "mongodb://mongo:27017/filledin-talent"
        MONGODB_DB: "filledin-talent"
    container_name: filledin_web
    restart: unless-stopped
    
    # Environment variables
    environment:
      NODE_ENV: production
      PORT: 3000
      NEXTAUTH_URL: https://filledintalent.com
      # Switch URI to the local container name 'mongo'
      MONGODB_URI: "mongodb://mongo:27017/filledin-talent"
      MONGODB_DB: "filledin-talent"
      # Keep your secret here or in .env
      NEXTAUTH_SECRET: "aGCNRhYNhc0H3avDv+oYTEPfemDBD8yCZuOV1Elf48Q="

    # 2. Mounts (Bind mounts to host directory)
    volumes:
      - ./storage/upload:/app/upload

    # 3. Network Isolation
    networks:
      - filledin_secure_net

    # 4. Traefik Configuration
    labels:
      - "traefik.enable=true"
      # Traefik must use the internal network to reach this container
      - "traefik.docker.network=filledin_secure_net"
      
      # HTTP Router
      - "traefik.http.routers.filledin-http.entrypoints=http"
      - "traefik.http.routers.filledin-http.rule=Host(`filledintalent.com`)"
      - "traefik.http.routers.filledin-http.middlewares=https-redirect@file"

      # HTTPS Router
      - "traefik.http.routers.filledin-https.entrypoints=https"
      - "traefik.http.routers.filledin-https.rule=Host(`filledintalent.com`)"
      - "traefik.http.routers.filledin-https.tls=true"
      - "traefik.http.routers.filledin-https.tls.certresolver=le"
      - "traefik.http.services.filledin.loadbalancer.server.port=3000"

    depends_on:
      - mongo

  mongo:
    image: mongo:6
    container_name: filledin_mongo
    restart: unless-stopped
    # Mount data to local folder in current directory
    volumes:
      - ./mongo-data:/data/db
    networks:
      - filledin_secure_net
